apiVersion: v1
kind: Service
metadata:
  name: backend
  labels:
    app: backend
spec:
  type: LoadBalancer
  ports:
    - port: 80
      targetPort: 5000
  selector:
    app: backend
---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: backend
spec:
  selector:
    matchLabels:
      app: backend
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - image: gcr.io/bitpull/backend:latest
        name: backend
        imagePullPolicy: Always
        ports:
        - containerPort: 5000
        env:
        - name: API_URL
          valueFrom:
            configMapKeyRef:
              key: API_URL
              name: backend-env
        - name: APP_URL
          valueFrom:
            configMapKeyRef:
              key: APP_URL
              name: backend-env
        - name: DATABASE_URI
          valueFrom:
            configMapKeyRef:
              key: DATABASE_URI
              name: backend-env
        - name: PUPPETEER_ENDPOINT
          value: ws://chrome:3000
        - name: GROWSURF_API_TOKEN
          valueFrom:
            secretKeyRef:
              name: growsurf
              key: token
        - name: GROWSURF_CAMPAIGN_ID
          valueFrom:
            configMapKeyRef:
              key: GROWSURF_CAMPAIGN_ID
              name: backend-env
        - name: GROWSURF_WEBHOOK_SECRET
          valueFrom:
            secretKeyRef:
              name: growsurf
              key: webhook
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            configMapKeyRef:
              key: AWS_ACCESS_KEY_ID
              name: backend-env
        - name: AWS_REGION
          valueFrom:
            configMapKeyRef:
              key: AWS_REGION
              name: backend-env
        - name: AWS_S3_BUCKET
          valueFrom:
            configMapKeyRef:
              key: AWS_S3_BUCKET
              name: backend-env
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: aws
              key: key
        - name: DROPBOX_CLIENT_ID
          valueFrom:
            configMapKeyRef:
              key: DROPBOX_CLIENT_ID
              name: backend-env
        - name: DROPBOX_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: dropbox
              key: secret
        - name: EMAIL_FROM_ADDRESS
          valueFrom:
            configMapKeyRef:
              key: EMAIL_FROM_ADDRESS
              name: backend-env
        - name: GOOGLE_CLIENT_ID
          valueFrom:
            configMapKeyRef:
              key: GOOGLE_CLIENT_ID
              name: backend-env
        - name: GOOGLE_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: google
              key: secret
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: jwt-secret
              key: key
        - name: ENCRYPTION_KEY
          valueFrom:
            secretKeyRef:
              name: encryption-key
              key: key
        - name: ONEDRIVE_CLIENT_ID
          valueFrom:
            configMapKeyRef:
              key: ONEDRIVE_CLIENT_ID
              name: backend-env
        - name: ONEDRIVE_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: onedrive
              key: secret
        - name: GITHUB_CLIENT_ID
          valueFrom:
            configMapKeyRef:
              key: GITHUB_CLIENT_ID
              name: backend-env
        - name: GITHUB_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: github
              key: secret
        - name: SENDGRID_API_KEY
          valueFrom:
            secretKeyRef:
              name: sendgrid
              key: key
        - name: SLACK_CLIENT_ID
          valueFrom:
            configMapKeyRef:
              key: SLACK_CLIENT_ID
              name: backend-env
        - name: SLACK_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: slack
              key: secret
        - name: STRIPE_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: stripe
              key: key
        - name: STRIPE_WEBHOOK_SECRET
          valueFrom:
            secretKeyRef:
              name: stripe
              key: webhook